<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of nt_cca</title>
  <meta name="keywords" content="nt_cca">
  <meta name="description" content="[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">NoiseTools</a> &gt; nt_cca.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for NoiseTools&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>nt_cca
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation

  A, B: transform matrices
  R: r scores

  x,y: column matrices
  shifts: positive lag means y delayed relative to x
  C: covariance matrix of [x, y]
  m: number of columns of x
  thresh: discard PCs below this 
  demeanflag: if true remove means [default: true]

  Usage 1:
   [A,B,R]=nt_cca(x,y); % CCA of x, y

  Usage 2: 
   [A,B,R]=nt_cca(x,y,shifts); % CCA of x, y for each value of shifts.
   A positive shift indicates that y is delayed relative to x.

  Usage 3:
   C=[x,y]'*[x,y]; % covariance
   [A,B,R]=nt_cca([],[],[],C,size(x,2)); % CCA of x,y

 Use the third form to handle multiple files or large data
 (covariance C can be calculated chunk-by-chunk). 

 C can be 3-D, which case CCA is derived independently from each page.

 Warning: means of x and y are NOT removed.
 Warning: A, B scaled so that (x*A)^2 and (y*B)^2 are identity matrices (differs from canoncorr).

 See nt_cov_lags, nt_relshift, nt_cov, nt_pca.

 NoiseTools.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>	[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation</li><li><a href="nt_cov_lags.html" class="code" title="function [C,tw,m]=nt_cov_lags(x,y,shifts,demeanflag)">nt_cov_lags</a>	[C,tw,m]=nt_cov_lags(x,y,shifts,nodemeanflag) - covariance of [x,y] with lags</li><li><a href="nt_demean.html" class="code" title="function [x,mn]=nt_demean(x,w)">nt_demean</a>	[y,mn]=nt_demean(x,w) - remove weighted mean over cols</li><li><a href="nt_greetings.html" class="code" title="function nt_greetings(reset)">nt_greetings</a>	nt_greetings - display message the first time the toolbox is used</li><li><a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>	nt_imagescc - plot image with symmetric scaling</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>	[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation</li><li><a href="nt_cca_crossvalidate.html" class="code" title="function [AA,BB,RR,iBest]=nt_cca_crossvalidate(xx,yy,shifts,ncomp,A0,B0)">nt_cca_crossvalidate</a>	[AA,BB,RR,iBest]=nt_cca_crossvalidate(xx,yy,shifts,ncomp,A0,B0) - CCA with cross-validation</li><li><a href="nt_cca_crossvalidate2.html" class="code" title="function [A,B,RR]=nt_cca_crossvalidate2(xx,yy,shifts)">nt_cca_crossvalidate2</a>	[A,B,RR]=nt_cca_crossvalidate2(xx,yy,shifts) - CCA with cross-validation</li><li><a href="nt_cca_crossvalidate_3.html" class="code" title="function [AA,BB,RR,iBest]=nt_cca_crossvalidate(xx,yy,shifts,ncomp,A0,B0,K)">nt_cca_crossvalidate_3</a>	[AA,BB,RR,iBest]=nt_cca_crossvalidate(xx,yy,shifts,ncomp,A0,B0) - CCA with cross-validation</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)</a>
0002 <span class="comment">%[A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag) - canonical correlation</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  A, B: transform matrices</span>
0005 <span class="comment">%  R: r scores</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  x,y: column matrices</span>
0008 <span class="comment">%  shifts: positive lag means y delayed relative to x</span>
0009 <span class="comment">%  C: covariance matrix of [x, y]</span>
0010 <span class="comment">%  m: number of columns of x</span>
0011 <span class="comment">%  thresh: discard PCs below this</span>
0012 <span class="comment">%  demeanflag: if true remove means [default: true]</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%  Usage 1:</span>
0015 <span class="comment">%   [A,B,R]=nt_cca(x,y); % CCA of x, y</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  Usage 2:</span>
0018 <span class="comment">%   [A,B,R]=nt_cca(x,y,shifts); % CCA of x, y for each value of shifts.</span>
0019 <span class="comment">%   A positive shift indicates that y is delayed relative to x.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%  Usage 3:</span>
0022 <span class="comment">%   C=[x,y]'*[x,y]; % covariance</span>
0023 <span class="comment">%   [A,B,R]=nt_cca([],[],[],C,size(x,2)); % CCA of x,y</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% Use the third form to handle multiple files or large data</span>
0026 <span class="comment">% (covariance C can be calculated chunk-by-chunk).</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% C can be 3-D, which case CCA is derived independently from each page.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Warning: means of x and y are NOT removed.</span>
0031 <span class="comment">% Warning: A, B scaled so that (x*A)^2 and (y*B)^2 are identity matrices (differs from canoncorr).</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% See nt_cov_lags, nt_relshift, nt_cov, nt_pca.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% NoiseTools.</span>
0036 
0037 <a href="nt_greetings.html" class="code" title="function nt_greetings(reset)">nt_greetings</a>; 
0038 
0039 <span class="keyword">if</span> nargin&lt;7||isempty(nodemeanflag); demeanflag=1; <span class="keyword">end</span>
0040 
0041 <span class="keyword">if</span> ~exist(<span class="string">'thresh'</span>,<span class="string">'var'</span>);
0042     thresh=10.^-12; 
0043 <span class="keyword">end</span>
0044 
0045 <span class="keyword">if</span> exist(<span class="string">'x'</span>,<span class="string">'var'</span>) &amp;&amp; ~isempty(x)
0046     <span class="comment">% Calculate covariance of [x,y]</span>
0047     <span class="keyword">if</span> ~exist(<span class="string">'y'</span>,<span class="string">'var'</span>); error(<span class="string">'!'</span>); <span class="keyword">end</span>
0048     <span class="keyword">if</span> ~exist(<span class="string">'shifts'</span>,<span class="string">'var'</span>)||isempty(<span class="string">'shifts'</span>); shifts=[0]; <span class="keyword">end</span>
0049     <span class="keyword">if</span> iscell(x) &amp;&amp; size(x{1},1) ~= size(y{1},1); 
0050         <span class="keyword">for</span> iTrial=1:numel(x);
0051             tmp=min(size(x{iTrial},1),size(y{iTrial},1));
0052             x{iTrial}=x{iTrial}(1:tmp,:);
0053             y{iTrial}=y{iTrial}(1:tmp,:);
0054         <span class="keyword">end</span>
0055     <span class="keyword">else</span>
0056         tmp=min(size(x,1),size(y,1));
0057         x=x(1:tmp,:,:);
0058         y=y(1:tmp,:,:);
0059     <span class="keyword">end</span>
0060 
0061     <span class="keyword">if</span> numel(shifts)==1 &amp;&amp; shifts==0 &amp;&amp; isnumeric(x) &amp;&amp; ndims(x)==2; 
0062         <span class="keyword">if</span> demeanflag
0063             x=<a href="nt_demean.html" class="code" title="function [x,mn]=nt_demean(x,w)">nt_demean</a>(x);
0064             y=<a href="nt_demean.html" class="code" title="function [x,mn]=nt_demean(x,w)">nt_demean</a>(y);
0065         <span class="keyword">end</span>
0066         C=[x,y]'*[x,y]; <span class="comment">% simple case</span>
0067         m=size(x,2); 
0068     <span class="keyword">else</span>        
0069         [C,~,m]=<a href="nt_cov_lags.html" class="code" title="function [C,tw,m]=nt_cov_lags(x,y,shifts,demeanflag)">nt_cov_lags</a>(x,y,shifts,demeanflag); <span class="comment">% lags, multiple trials, etc.</span>
0070     <span class="keyword">end</span>
0071     [A,B,R]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>([],[],[],C,m,thresh);
0072     
0073     <span class="keyword">if</span> nargout==0 
0074         <span class="comment">% plot something nice</span>
0075         <span class="keyword">if</span> length(shifts)&gt;1;
0076             figure(1); clf;
0077             plot(R'); title(<span class="string">'correlation for each CC'</span>); xlabel(<span class="string">'lag'</span>); ylabel(<span class="string">'correlation'</span>);
0078         <span class="keyword">end</span>
0079      <span class="keyword">end</span>
0080     <span class="keyword">return</span>
0081 <span class="keyword">end</span> <span class="comment">% else keep going</span>
0082 
0083 <span class="keyword">if</span> ~exist(<span class="string">'C'</span>,<span class="string">'var'</span>) || isempty(C) ; error(<span class="string">'!'</span>); <span class="keyword">end</span>
0084 <span class="keyword">if</span> ~exist(<span class="string">'m'</span>,<span class="string">'var'</span>); error(<span class="string">'!'</span>); <span class="keyword">end</span>
0085 <span class="keyword">if</span> size(C,1)~=size(C,2); error(<span class="string">'!'</span>); <span class="keyword">end</span>
0086 <span class="keyword">if</span> ~isempty(x) || ~isempty(y) || ~isempty(shifts)  ; error(<span class="string">'!'</span>); <span class="keyword">end</span>
0087 <span class="keyword">if</span> ndims(C)&gt;3; error(<span class="string">'!'</span>); <span class="keyword">end</span>
0088 
0089 <span class="keyword">if</span> ndims(C) == 3
0090     <span class="comment">% covariance is 3D: do a separate CCA for each page</span>
0091     N=min(m,size(C,1)-m); <span class="comment">% note that for some pages there may be fewer than N CCs</span>
0092     A=zeros(m,N,size(C,3));
0093     B=zeros(size(C,1)-m,N,size(C,3));
0094     R=zeros(N,size(C,3));
0095     <span class="keyword">for</span> k=1:size(C,3);
0096         [AA,BB,RR]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>([],[],[],C(:,:,k),m);
0097         A(1:size(AA,1),1:size(AA,2),k)=AA;
0098         B(1:size(BB,1),1:size(BB,2),k)=BB;
0099         R(1:size(RR,2),k)=RR;
0100     <span class="keyword">end</span>
0101     <span class="keyword">return</span>;
0102 <span class="keyword">end</span> <span class="comment">% else keep going</span>
0103 
0104 
0105 <span class="comment">%%</span>
0106 <span class="comment">% Calculate CCA given C=[x,y]'*[x,y] and m=size(x,2);</span>
0107 
0108 <span class="comment">% sphere x</span>
0109 Cx=C(1:m,1:m);
0110 [V, S] = eig(Cx) ;  
0111 V=real(V); S=real(S);
0112 [E, idx] = sort(diag(S)', <span class="string">'descend'</span>) ;
0113 keep=find(E/max(E)&gt;thresh);
0114 topcs = V(:,idx(keep));
0115 E = E (keep);
0116 EXP=1-10^-12; 
0117 E=E.^EXP; <span class="comment">% break symmetry when x and y perfectly correlated (otherwise cols of x*A and y*B are not orthogonal)</span>
0118 A1=topcs*diag(sqrt((1./E)));
0119 
0120 <span class="comment">% sphere y</span>
0121 Cy=C(m+1:<span class="keyword">end</span>,m+1:end);
0122 [V, S] = eig(Cy) ;  
0123 V=real(V); S=real(S);
0124 [E, idx] = sort(diag(S)', <span class="string">'descend'</span>) ;
0125 keep=find(E/max(E)&gt;thresh);
0126 topcs = V(:,idx(keep));
0127 E = E (keep);
0128 E=E.^EXP; <span class="comment">%</span>
0129 A2=topcs*diag(sqrt((1./E)));
0130 
0131 <span class="comment">% apply sphering matrices to C</span>
0132 AA=zeros( size(A1,1)+size(A2,1), size(A1,2)+size(A2,2) );
0133 AA( 1:size(A1,1), 1:size(A1,2) )=A1;
0134 AA( size(A1,1)+1:<span class="keyword">end</span>, size(A1,2)+1:end )=A2;
0135 C= AA' * C * AA;
0136 
0137 N=min(size(A1,2),size(A2,2)); <span class="comment">% number of canonical components</span>
0138 
0139 <span class="comment">% PCA</span>
0140 [V, S] = eig(C) ;
0141 <span class="comment">%[V, S] = eigs(C,N) ; % not faster</span>
0142 V=real(V); S=real(S);
0143 [E, idx] = sort(diag(S)', <span class="string">'descend'</span>) ;
0144 topcs = V(:,idx);
0145 
0146 A=A1*topcs(1:size(A1,2),1:N)*sqrt(2);  <span class="comment">% why sqrt(2)?...</span>
0147 B=A2*topcs(size(A1,2)+1:<span class="keyword">end</span>,1:N)*sqrt(2);
0148 R=E(1:N)-1; 
0149 
0150 
0151 <span class="comment">%{</span>
0152 Why does it work?
0153 If x and y were uncorrelated, eigenvalues E would be all ones. 
0154 Correlated dimensions (the canonical correlates) should give values E&gt;1, 
0155 i.e. they should map to the first PCs. 
0156 To obtain CCs we just select the first N PCs. 
0157 <span class="comment">%}</span>
0158 
0159 <span class="comment">%%</span>
0160 
0161 <span class="comment">%%</span>
0162 <span class="comment">% test code</span>
0163 <span class="keyword">if</span> 0
0164     <span class="comment">% basic</span>
0165     clear
0166     x=randn(10000,20);
0167     y=randn(10000,8);
0168     y(:,1:2)=x(:,1:2); <span class="comment">% perfectly correlated</span>
0169     y(:,3:4)=x(:,3:4)+randn(10000,2); <span class="comment">% 1/2 correlated</span>
0170     y(:,5:6)=x(:,5:6)+randn(10000,2)*3; <span class="comment">% 1/4 correlated</span>
0171     y(:,7:8)=randn(10000,2); <span class="comment">% uncorrelated</span>
0172     [A,B,R]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(x,y);
0173     figure(1); clf
0174     subplot 321; imagesc(A); title(<span class="string">'A'</span>);
0175     subplot 322; imagesc(B); title(<span class="string">'B'</span>);
0176     subplot 323; plot(R, <span class="string">'.-'</span>); title(<span class="string">'R'</span>)
0177     subplot 324; <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>((x*A)'*(x*A)); title (<span class="string">'covariance of x*A'</span>);
0178     subplot 325; <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>((y*B)'*(y*B)); title (<span class="string">'covariance of y*B'</span>);
0179     subplot 326; <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>([x*A,y*B]'*[x*A,y*B]); title (<span class="string">'covariance of [x*A,y*B]'</span>);
0180 <span class="keyword">end</span>
0181 
0182 <span class="keyword">if</span> 0 
0183     <span class="comment">% compare with canoncorr</span>
0184     clear
0185     x=randn(1000,11);
0186     y=randn(1000,9);
0187     x=x-repmat(mean(x),size(x,1),1); <span class="comment">% center, otherwise result may differ slightly from canoncorr</span>
0188     y=y-repmat(mean(y),size(y,1),1);
0189     [A1,B1,R1]=canoncorr(x,y);
0190     [A2,B2,R2]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(x,y);   
0191     A2=A2*sqrt(size(x,1)); <span class="comment">% scale like canoncorr</span>
0192     B2=B2*sqrt(size(y,1));
0193     figure(1); clf; 
0194     subplot 211; 
0195     plot([R1' R2']); title(<span class="string">'R'</span>); legend({<span class="string">'canoncorr'</span>, <span class="string">'nt_cca'</span>}, <span class="string">'Interpreter'</span>,<span class="string">'none'</span>); 
0196     <span class="keyword">if</span> mean(A1(:,1).*A2(:,1))&lt;0; A2=-A2; <span class="keyword">end</span>
0197     subplot 212; 
0198     plot(([x*A1(:,1),x*A2(:,1)])); title(<span class="string">'first component'</span>); legend({<span class="string">'canoncorr'</span>, <span class="string">'nt_cca'</span>}, <span class="string">'Interpreter'</span>,<span class="string">'none'</span>); 
0199     figure(2); clf;set(gcf,<span class="string">'defaulttextinterpreter'</span>,<span class="string">'none'</span>)
0200     subplot 121; 
0201     <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>([x*A1,y*B1]'*[x*A1,y*B1]); title(<span class="string">'canoncorr'</span>); 
0202     subplot 122; 
0203     <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>([x*A2,y*B2]'*[x*A2,y*B2]); title(<span class="string">'nt_cca'</span>);
0204 <span class="keyword">end</span>
0205 
0206 <span class="keyword">if</span> 0
0207     <span class="comment">% time</span>
0208     x=randn(100000,100); 
0209     tic; 
0210     [A,B,R]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(x,x); 
0211     disp(<span class="string">'nt_cca time: '</span>);
0212     toc    
0213     [A,B,R]=canoncorr(x,x); 
0214     disp(<span class="string">'canoncorr time: '</span>);
0215     toc
0216 <span class="comment">%     [A,B,R]=cca(x,x);</span>
0217 <span class="comment">%     disp('cca time: ');</span>
0218 <span class="comment">%     toc</span>
0219 <span class="keyword">end</span>
0220 
0221 <span class="keyword">if</span> 0
0222     <span class="comment">% shifts</span>
0223     x=randn(1000,10);
0224     y=randn(1000,10);
0225     y(:,1:3)=x(:,1:3);
0226     shifts=-10:10;
0227     [A1,B1,R1]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(x,y,shifts);
0228     figure(1); clf
0229     plot(shifts,R1'); xlabel(<span class="string">'lag'</span>); ylabel(<span class="string">'R'</span>);
0230 <span class="keyword">end</span>
0231 
0232 <span class="keyword">if</span> 0
0233     <span class="comment">% what happens if x &amp; y perfectly correlated?</span>
0234     x=randn(1000,10);
0235     y=randn(1000,10); y=x(:,randperm(10)); <span class="comment">%+0.000001*y;</span>
0236     [A1,B1,R1]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(x,y);
0237     figure(1); clf
0238     <a href="nt_imagescc.html" class="code" title="function nt_imagescc(C)">nt_imagescc</a>([x*A1,y*B1]'*[x*A1,y*B1]);
0239 <span class="keyword">end</span>    
0240 
0241 <span class="keyword">if</span> 0
0242     <span class="comment">% x and y are cell arrays</span>
0243     x=randn(1000,10); 
0244     y=randn(1000,10);
0245     xx={x,x,x};  yy={x,y,y};
0246     [A,B,R]=<a href="nt_cca.html" class="code" title="function [A,B,R]=nt_cca(x,y,shifts,C,m,thresh,demeanflag)">nt_cca</a>(xx,yy);
0247     disp(<span class="string">'seems to work...'</span>);
0248 <span class="keyword">end</span>
0249 
0250     
0251</pre></div>
<hr><address>Generated on Thu 23-Jul-2020 16:52:47 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>